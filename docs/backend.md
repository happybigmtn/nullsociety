# Backend Architecture Notes (Testnet)

This document summarizes backend design expectations for the testnet build: error handling, configuration, integration points, and operational tooling.

## Error handling + safety
- Casino engine and execution handlers return Result-based errors (no `panic!`/`unwrap` in production paths).
- Player-facing failures emit `CasinoError` events; server logs include structured fields (player, session_id, error_code).
- Lock poisoning is handled gracefully in simulator/state tracking (poisoned locks recover with warning).

## Configuration + limits
- Deployment limits and defaults are centralized and documented in `docs/limits.md`.
- Node tunables are configured via `configs/*/nodeN.yaml` (generated by `node/src/bin/generate_keys.rs`).
- Simulator rate limits and body size caps are set via config/CLI and env overrides:
  - `RATE_LIMIT_HTTP_PER_SEC`, `RATE_LIMIT_HTTP_BURST`, `RATE_LIMIT_SUBMIT_PER_MIN`, `RATE_LIMIT_SUBMIT_BURST`
  - `ALLOW_HTTP_NO_ORIGIN=1` and `ALLOW_WS_NO_ORIGIN=1` for CLI health checks (no Origin header).

## Service overview
- `nullspace-simulator`: HTTP API, WebSocket updates, explorer indexing/persistence, Prometheus metrics.
- `nullspace-node`: consensus validators with metrics on port 9100+.
- `services/auth`: session auth + AI proxy endpoint (`POST /ai/strategy`).
- `gateway`: websocket session manager for app clients (registration, deposits, updates stream).
- `client` bins: operational tooling (bridge relayer, tournament scheduler, stress-test bots, diagnostics).

## Operational tooling
- Tournament scheduler: `client/src/bin/tournament_scheduler.rs` (wrap via `scripts/run-tournament-scheduler.sh`).
- Bot load runner: `client/src/bin/stress_test.rs` (wrap via `scripts/run-bots.sh`).
- Session diagnostics: `client/src/bin/session_dump.rs` for quick state and history inspection.
- Multi-node soak test: `scripts/soak-test.sh` (requires simulator + nodes).

## Observability
- Metrics endpoints and Grafana quickstart: see `docs/observability.md`.
- Game metrics exported by the simulator:
  - `nullspace_simulator_casino_games_*`, `nullspace_simulator_casino_active_sessions`
- Node metrics include runtime memory gauges and engine block progress:
  - `runtime_process_rss`, `runtime_process_virtual_memory`
  - `engine_marshal_verified_blocks_journal_tracked`

## External chain integration (optional)
- EVM lockbox relayer: `client/src/bin/bridge_relayer.rs`.
- Contracts live under `evm/contracts` (BridgeLockbox/RNG token).

## AI strategy proxy
- Backend proxy endpoint lives in `services/auth/src/server.ts` at `POST /ai/strategy`.
- Configure via `GEMINI_API_KEY`, `GEMINI_MODEL`, and `AUTH_AI_RATE_LIMIT_*` in auth service env.
